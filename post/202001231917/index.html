<!doctype html><html xmlns=http://www.w3.org/1999/xhtml lang=ja><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>DMM.go #1 | jkkitakita</title><meta property="og:title" content="DMM.go #1 - jkkitakita"><meta property="og:description" content="DMM.go #1"><meta property="og:url" content="https://blog.jkkitakita.dev/post/202001231917/"><meta property="og:site_name" content="jkkitakita"><meta property="og:type" content="article"><meta property="og:image" content="https://www.gravatar.com/avatar/23c25c7545ad2fdbdbab1f9201bf96b7?s=256"><meta property="article:author" content="https://facebook.com/jkkitakita"><meta property="article:section" content="Post"><meta property="article:tag" content="Go"><meta property="article:tag" content="event"><meta property="article:published_time" content="2020-01-23T19:17:25+09:00"><meta property="article:modified_time" content="2020-01-23T19:17:25+09:00"><meta name=twitter:card content="summary"><meta name=twitter:site content="@jkkitakita"><meta name=twitter:creator content="@jkkitakita"><link href=https://blog.jkkitakita.dev/index.xml rel=alternate type=application/rss+xml title=jkkitakita><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://blog.jkkitakita.dev/css/custom.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=https://blog.jkkitakita.dev/post/202001231917/><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"></head><body><section class=section><div class=container><nav id=nav-main class=nav><div id=nav-name class=nav-left><a id=nav-anchor class=nav-item href=https://blog.jkkitakita.dev><h1 id=nav-heading class="title is-4">jkkitakita</h1></a></div><div class=nav-right><nav id=nav-items class="nav-item level is-mobile"><a class=level-item aria-label=github href=https://github.com/jkkitakita target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></i></span></a><a class=level-item aria-label=facebook href=https://facebook.com/jkkitakita target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M18 2h-3a5 5 0 00-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 011-1h3z"/></svg></i></span></a><a class=level-item aria-label=twitter href=https://twitter.com/jkkitakita target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></i></span></a><a class=level-item aria-label=instagram href=https://instagram.com/jkkitakita target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"/><path d="M16 11.37A4 4 0 1112.63 8 4 4 0 0116 11.37z"/><line x1="17.5" y1="6.5" x2="17.5" y2="6.5"/></svg></i></span></a><a class=level-item aria-label=email href=mailto:jkkitakita@gmail.com target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></i></span></a><a class=level-item aria-label=linkedin href=https://linkedin.com/in/jkkitakita target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path stroke-width="1.8" d="m5.839218 4.101561c0 1.211972-.974141 2.194011-2.176459 2.194011S1.4863 5.313533 1.4863 4.101561c0-1.211094.974141-2.194011 2.176459-2.194011s2.176459.982917 2.176459 2.194011zm.017552 3.94922h-4.388022v14.04167H5.85677V8.050781zm7.005038.0H8.501869v14.04167h4.360816v-7.370999c0-4.098413 5.291077-4.433657 5.291077.0v7.370999h4.377491v-8.89101c0-6.915523-7.829986-6.66365-9.669445-3.259423V8.050781z"/></svg></i></span></a></nav></div></nav><nav class=nav></nav></div><script src=/js/navicon-shift.js></script></section><section class=section><div class=container><div class="subtitle tags is-6 is-pulled-right"><a class="subtitle is-6" href=/tags/go/>#Go</a>
| <a class="subtitle is-6" href=/tags/event/>#event</a></div><h2 class="subtitle is-6">January 23, 2020</h2><h1 class=title>DMM.go #1</h1><div class=content><p>DMM さんの Go の勉強会に行ってきたので、その時のメモ。</p><p><a href=https://dmm.connpass.com/event/157222/>https://dmm.connpass.com/event/157222/</a></p><p>適宜、スライド追記されたら更新する予定。</p><h2 id=タイムスケジュール>タイムスケジュール</h2><p><img src=/images/dmm_go_01.png alt=dmm_go_01></p><p>c.f. <a href=https://dmm.connpass.com/event/157222/>DMM.go #1</a>
（スクショがダメだったら、削除します。）</p><h2 id=内容>内容</h2><h3 id=オープニング開催趣旨-i35_267httpstwittercomi35_267>オープニング・開催趣旨 <a href=https://twitter.com/i35_267>@i35_267</a></h3><ul><li>会場案内</li><li>DMM グループの Go の勉強会です<ul><li><a href=https://www.dmm.com/>DMM.com</a></li><li><a href=https://games.dmm.com/>DMM GAMES</a></li><li><a href=https://picappinc.jp/>PicApp</a></li></ul></li></ul><h3 id=cloud-native-な時代に考える-monorepo-y_matsuwitterhttpstwittercomy_matsuwitter>Cloud Native な時代に考える monorepo <a href=https://twitter.com/y_matsuwitter>@y_matsuwitter</a></h3><h4 id=cloud-native-時代の開発と現状>Cloud Native 時代の開発と現状</h4><ul><li>マイクロサービスが前提になってきている</li><li>組織戦略とも絡んでくるよね。ってなって monorepo をテーマにしようと思った。</li></ul><h4 id=改めてcloud-native-とは>改めて、Cloud Native とは</h4><ul><li><a href=https://github.com/cncf/toc/blob/master/DEFINITION.md#%E6%97%A5%E6%9C%AC%E8%AA%9E%E7%89%88>CNCF が出している Cloud Native の定義</a>の紹介</li><li>Cloud の利点を適切に理解して、使う必要があるよね。</li></ul><h4 id=cloud-native-時代の基盤の選択肢>Cloud Native 時代の基盤の選択肢</h4><ul><li>Kubernetes</li><li>Container as a Service</li><li>FaaS</li><li>Managed Service</li><li>とかとか、いろいろなユースケースがあって</li><li>アーキテクチャは、チームと寄り添いながら、運営していく必要がある。</li></ul><h4 id=そこでなんで-monorepo-なのか>そこで、なんで monorepo なのか？</h4><ul><li>アプリケーションが色々散らばっている。</li><li>かつ、そのプロトコルも複数ある。</li><li>特に Managed Service は、プロトコルが決まっていて、それぞれ使わないといけないプロトコルが決まっていたりする。</li><li>monorepo という選択肢がいいんじゃないか。</li></ul><h4 id=monorepo-とは>monorepo とは？</h4><ul><li>Package 間の interface を一括管理できる</li></ul><h4 id=なぜ-monorepo>なぜ monorepo？</h4><ul><li>パッケージ間の interface を 1 つのリポジトリに集約する</li><li>仕組みの共有が容易。</li></ul><h4 id=go-と-bazel-で-cloud-native-な-monorepo-運用>Go と bazel で Cloud Native な monorepo 運用</h4><h5 id=課題>課題</h5><ul><li>全サービスのソースコードが集まる<ul><li>全体をビルドしテストするコストは、サービスが拡大するごとに増える</li></ul></li><li>ビルド方法の多様化<ul><li>様々な基盤に合わせたツールが必要になる</li></ul></li></ul><h5 id=対策>対策</h5><ul><li>賢いビルドツール<ul><li>依存関係の解析</li><li>依存グラフから再ビルド・再テスト</li></ul></li></ul><h4 id=そこでbazelhttpsbazelbuildの登場>そこで、<a href=https://bazel.build/>bazel</a>の登場</h4><h5 id=特徴>特徴</h5><ul><li>依存関係に応じて、影響する部分を特定ビルド</li><li>ビルド結果のキャッシュにより、不要なビルドを行わない</li><li>キャッシュはローカルだけではなく、リモート環境も指定可能。</li><li>様々な言語に対応している。</li></ul><h4 id=go-と-bazel-で-monorepo>Go と bazel で monorepo</h4><h5 id=gazellehttpsgithubcombazelbuildbazel-gazelle><a href=https://github.com/bazelbuild/bazel-gazelle>Gazelle</a></h5><ul><li>ビルド対象・依存関係を細かく指定する必要がない。<ul><li>依存関係を自動生成してくれる。</li></ul></li><li>bazel を運用するには、ほぼ必須（？）</li></ul><h5 id=bazel-の課題>bazel の課題</h5><ul><li>依存関係を全て記述する必要がある<ul><li>各言語</li></ul></li><li>bazel 自体の機能が豊富すぎる<ul><li>学習コストが高め</li><li>bazel の面倒をみる。DevOps 的なチームが必要。</li></ul></li></ul><h5 id=各ツールとの組み合わせ>各ツールとの組み合わせ</h5><ul><li>protobuf との相性<ul><li>bazel 側機能を利用すると都度 go コードを生成してしまう。<ul><li>生成結果もコミットしたい場合は、bazel を使わない必要がある？</li></ul></li></ul></li><li>ほとんどの生成過程を bazel のキャッシュディレクトリで実施する必要がある。</li></ul><h3 id=practical-distributed-tracing-hatsunemiku3939httpsgithubcomhatsunemiku3939>PRACTICAL DISTRIBUTED TRACING <a href=https://github.com/HatsuneMiku3939>@HatsuneMiku3939</a></h3><div style=position:relative;padding-bottom:56.25%;padding-top:30px;height:0;overflow:hidden><iframe src=//docs.google.com/presentation/d/1HVSQaEU1rsycka--QYKaODJHO1eNPNlmk0tz_ON_YYM style=position:absolute;top:0;left:0;width:100%;height:100% allowfullscreen frameborder=0></iframe></div><p><a href="https://docs.google.com/presentation/d/1HVSQaEU1rsycka--QYKaODJHO1eNPNlmk0tz_ON_YYM/edit#slide=id.g33148270ac_0_143">PRACTICAL DISTRIBUTED TRACING</a></p><h4 id=マイクロサービスで出てくる分散トレーシングの話>マイクロサービスで出てくる。分散トレーシングの話。</h4><ul><li>分散アプリの性能を計測する仕組み。</li><li>従来の APM と何が違う？<ul><li>1 リクエスト（従来の APM） -> 複数バックエンド（分散トレーシング）</li><li>個々のサービスを測定（従来の APM） -> 全体は把握できない。（分散トレーシング）</li></ul></li><li>リクエスト全体の「処理の流れ」を把握するモノ。<ul><li>処理の単位は、Trace と Span に分かれている</li></ul></li></ul><h4 id=trace>Trace</h4><ul><li>システムを貫通するリクエストの集合体</li></ul><h4 id=span>Span</h4><ul><li>作業の単位</li><li>1 Trace は 1 以上の Span で構成される</li><li>前後がわかるように親子関係を持っている</li></ul><h4 id=基本はあるサービスの-outbound-は他のサービスの-inbound>基本は、「あるサービスの Outbound は、他のサービスの Inbound。」</h4><h5 id=inbound-するとき>Inbound するとき</h5><ul><li>とりあえず、新しい Span を生成</li><li>親子関係を作成する</li><li>TraceID がなかったら、作る</li></ul><h5 id=outbound-するとき>Outbound するとき</h5><ul><li>Span ID 伝搬する。<ul><li>基本は Header。（ダメなら、body？）<ul><li>gRPC, kafka etc&mldr;</li></ul></li></ul></li></ul><h4 id=opencensus>OpenCensus</h4><h5 id=opencensus-とは>OpenCensus とは。</h5><ul><li>問題は、ソリューションがいっぱいあって、SDK がそれぞれ異なるが、これを選んだ。</li><li>一番しっかりできていると思っている。</li><li>いろいろな機能があるが、主な目的は、分散トレーシング。</li><li>StackDriver とか X-ray とかにも export することができる。<ul><li>c.f. <a href=https://opencensus.io/exporters/>https://opencensus.io/exporters/</a></li></ul></li></ul><h5 id=やるべき-3-つのこと>やるべき 3 つのこと</h5><ul><li>Exporter の初期化<ul><li>Jaeger の例を出してますが、ほぼコピペで行ける。</li></ul></li><li>Inbound トレーシング</li><li>Outbound トレーシング</li></ul><p>基本的にこれだけ。</p><h5 id=他にも機能がいっぱい>他にも機能がいっぱい！</h5><ul><li>gRPC tracing</li><li>Server Clent metric</li><li>DB Integration etc&mldr;</li></ul><h5 id=実戦運用>実戦運用</h5><ul><li>小規模なら Agent なし<ul><li>直接 backend に送れば ok! e.g. X-ray, Datadog<ul><li>コピペで行ける</li></ul></li></ul></li><li>大規模なら Agent あり<ul><li>各 instance に OpenCensus Agent を用意して、各種サービスから Agent に送る<ul><li>Kubernetes なら、daemonset で用意する。</li></ul></li><li>一度 Agent が受けて、その後、backend に送れば ok.</li></ul></li></ul><h4 id=最後に>最後に</h4><ul><li>ただ、OpenCensus は OpenTracing と統合されて、OpenTelementary になる。</li></ul><h3 id=vcr-in-goモック自動生成で楽しちゃう話-yyh_glhttpstwittercomyyh_gl>VCR in Go：モック自動生成で楽しちゃう話 <a href=https://twitter.com/yyh_gl>@yyh_gl</a></h3><div class=embed><script async class=speakerdeck-embed data-id=e03f7c5484e84f7eac649202ea4c2327 data-slide data-ratio=1.77777777777777 src=//speakerdeck.com/assets/embed.js></script></div><h4 id=はじめに>はじめに</h4><ul><li>皆さんテスト書いてますか？</li><li>外部システムをモック化したい</li><li>モック管理あるある<ul><li>ただ、「モックだから動けばいっか？」みたいなことが多いはず。</li></ul></li><li>モックを手動で作成する時点でもうきつい。</li><li>なので、モックコードを自動生成する<ul><li>OpenAPI（Swagger）</li><li>Video Cassette Recorder</li></ul></li></ul><h4 id=vcr>VCR</h4><ul><li>大事なのは、確実に、実際のレスポンスをモック化できること</li><li>紹介するのは、<a href=https://github.com/dnaeon/go-vcr>dnaeon/go-vcr</a><ul><li><a href=https://github.com/vcr/vcr>vcr/vcr</a>の Go バージョン</li></ul></li></ul><h5 id=基本的な要素は２つ>基本的な要素は２つ</h5><h6 id=recorder>Recorder</h6><ul><li>レスポンスを記録するやつ</li><li>実態は、構造体</li></ul><h6 id=casete>Casete</h6><ul><li>保存したレスポンス</li><li>yaml</li></ul><h5 id=特徴と運用方法>特徴と運用方法</h5><ul><li>リクエストの同一性について<ul><li>デフォルトでは、下記パラメータが同じであれば、同一リクエストとして判定</li></ul></li><li>保存内容を修正したいときは、cassette を消せば ok!<ul><li>yaml を直接修正は、おすすめしない。</li></ul></li><li>運用方法<ul><li>STG 環境のレスポンスを保存</li><li>テスト関数ごとにカセットを用意</li></ul></li></ul><h5 id=メリットデメリット>メリット・デメリット</h5><ul><li>メリット<ul><li>モックと実システム間の仕様のズレがなくなり。</li><li>HTTP ではなく、ファイルの読み込みでよくなって、早くなる。</li><li>「ローカルでは動いたのに、、、」が減る！</li></ul></li><li>デメリット<ul><li>アクセストークンの再取得</li><li>カセット単位でレスポンス</li></ul></li></ul><h3 id=チャット小説アプリ-teller-を支える-gaego-tomoemonhttpstwittercomtomoemon>チャット小説アプリ TELLER を支える GAE/Go <a href=https://twitter.com/tomoemon>@tomoemon</a></h3><h4 id=はじめに-1>はじめに</h4><ul><li>Go よりかは、プロダクト寄りの話多め。</li><li>チャット型小説アプリ TELLER の紹介</li><li>パッケージ依存関係 CI<ul><li>クリーンアーキテクチャに変えてみたが、どこからどこへ依存して良いのか、何をどこに書くべきかわからないメンバーもいた。</li><li>Golang のパッケージ依存関係チェックツールを作って、CI<ul><li><a href=https://github.com/tomoemon/impas>https://github.com/tomoemon/impas</a></li></ul></li></ul></li></ul><h4 id=di-自動化したい>DI 自動化したい</h4><ul><li>DI 自動化したい。<a href=https://github.com/google/wire>wire</a>入れよう！</li><li>後々ジョインするメンバーの参入障壁があがる？</li><li>詳細的に言語機能との差異が生まれて負債にならないか？</li></ul><h4 id=課題と対策>課題と対策</h4><ul><li>広告で見たストーリーを見つけられない<ul><li>2 年前は検索機能がなかった。</li><li>色々検索サービスを検討した<ul><li>Elasticsearch</li><li>GAE Search</li><li>Algolia</li></ul></li><li>機能の学習コスト等の観点から、結局、Algolia にした</li></ul></li><li>Algolia<ul><li>ソートの癖がすごい。</li><li>料金プランが 1 年スパンでどんどん変わる<ul><li>使い始めて、1 年後には、無料だったものに、従量課金されてた。</li></ul></li><li>インデックスしたはずが Algolia 上にない<ul><li>問い合わせたら、再インデックスしてくれと言われる</li></ul></li></ul></li><li>Redis でランキング集計つらい<ul><li>Redis -> BigQuery に変えた。</li></ul></li><li>ストーリー更新をトリガーにして色々したい<ul><li>イベント駆動にした。Cloud Tasks を使って解決できた。</li></ul></li><li>アダルト画像を上げまくるユーザーをどうにかしたい。<ul><li><a href=http://e-words.jp/w/CGM.html>CGM</a>あるある。</li><li>元々は、外注して、人力目視チェック。</li><li><a href="https://cloud.google.com/vision/?hl=ja&utm_source=google&utm_medium=cpc&utm_campaign=japac-JP-all-ja-dr-bkws-all-all-trial-e-dr-1008074&utm_content=text-ad-none-none-DEV_c-CRE_285865410190-ADGP_Hybrid+%7C+AW+SEM+%7C+BKWS+~+T1+%7C+EXA+%7C+ML+%7C+M:1+%7C+JP+%7C+ja+%7C+Vision+%7C+General+%7C+en-KWID_43700016101235133-kwd-203288729047&userloc_1009310&utm_term=KW_cloud%20vision%20api&gclid=Cj0KCQiApaXxBRDNARIsAGFdaB_G25M6NkjchBaI210iZ8crRUvX8i70dRlKe_vhCRMbatl0CX6P4NYaAhA4EALw_wcB">Cloud Vision API</a>を使えばよくね？<ul><li>サツマイモの画像でも、Violence な画像と判定されてしまうなどの精度の問題があった。</li><li>最終的には、一次切り分けとして Cloud Vision API を利用することとした。</li></ul></li></ul></li><li>ユーザ権限管理<ul><li>Role interface を実装 e.g. func CanXXXX() bool</li></ul></li></ul><h2 id=参考>参考</h2><ul><li><a href=https://www.cncf.io/>CNCF</a></li><li>Bazel 関連<ul><li><a href=https://github.com/bazelbuild/rules_go>Go rules for Bazel</a><ul><li>基本はここを見て、やるのが良さそう？</li></ul></li><li><a href=https://medium.com/mixi-developers/go-project-with-bazel-ad807ba19f5c>Go と Bazel</a></li><li><a href=https://qiita.com/mmmknt/items/cb23a597dfb5a4ca6353>Golang+Bazel で依存ライブラリをいい感じに管理する</a></li><li><a href=https://qiita.com/akrisn/items/ebb77073824c3d6fcde1>ProtocolBuffers を使っている Go のプロジェクトを Bazel でビルドする</a></li></ul></li><li><a href=https://opentelemetry.io/>OpenTelemetry</a></li></ul><div class=related><h3>Similar articles:</h3><ul><li><a href=/post/202001150046/>Goもくもく会（ごもくかい）#23</a></li><li><a href=/post/202001191310/>iOS・SwiftプロジェクトのCI/CDで、bitrise.ymlをリポジトリ内で管理する</a></li></ul></div></div></div></section><section class=section><div class="container has-text-centered"><p>(C) <a href=https://github.com/jkkitakita>Jun Kitamura</a> 2020</p></div></section><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-156067080-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript>var _paq=_paq||[];_paq.push(['trackPageView']);_paq.push(['enableLinkTracking']);(function(){var u="\/\/matomo.example.com\/";_paq.push(['setTrackerUrl',u+'piwik.php']);_paq.push(['setSiteId','1']);var d=document,g=d.createElement('script'),s=d.getElementsByTagName('script')[0];g.type='text/javascript';g.async=true;g.defer=true;g.src=u+'piwik.js';s.parentNode.insertBefore(g,s);})();</script><noscript><img src="//matomo.example.com/piwik.php?idsite=1&rec=1" style=border:0 alt></noscript></body></html>