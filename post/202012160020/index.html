<!doctype html><html xmlns=http://www.w3.org/1999/xhtml lang=ja><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>puppet bolt のディレクトリ構成 | jkkitakita</title><meta property="og:title" content="puppet bolt のディレクトリ構成 - jkkitakita"><meta property="og:description" content="この記事は Puppet Advent Calendar 2020 8 日目 の記事です。 はじめに puppet bolt のディレクトリ構成 各ディレクトリ・ファイルについて .modules .resource_types Puppetfile bolt-debug.log bolt-project.yaml data hiera.yaml inventory.yaml tasks site-modules files templates plans さいごに 参考 はじ"><meta property="og:url" content="https://blog.jkkitakita.dev/post/202012160020/"><meta property="og:site_name" content="jkkitakita"><meta property="og:type" content="article"><meta property="og:image" content="https://www.gravatar.com/avatar/23c25c7545ad2fdbdbab1f9201bf96b7?s=256"><meta property="article:author" content="https://facebook.com/jkkitakita"><meta property="article:section" content="Post"><meta property="article:tag" content="puppet"><meta property="article:tag" content="puppet bolt"><meta property="article:published_time" content="2020-12-16T00:20:36+09:00"><meta property="article:modified_time" content="2020-12-16T00:20:36+09:00"><meta name=twitter:card content="summary"><meta name=twitter:site content="@jkkitakita"><meta name=twitter:creator content="@jkkitakita"><link href=https://blog.jkkitakita.dev/index.xml rel=alternate type=application/rss+xml title=jkkitakita><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://blog.jkkitakita.dev/css/custom.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=https://blog.jkkitakita.dev/post/202012160020/><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"></head><body><section class=section><div class=container><nav id=nav-main class=nav><div id=nav-name class=nav-left><a id=nav-anchor class=nav-item href=https://blog.jkkitakita.dev><h1 id=nav-heading class="title is-4">jkkitakita</h1></a></div><div class=nav-right><nav id=nav-items class="nav-item level is-mobile"><a class=level-item aria-label=github href=https://github.com/jkkitakita target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></i></span></a><a class=level-item aria-label=facebook href=https://facebook.com/jkkitakita target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M18 2h-3a5 5 0 00-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 011-1h3z"/></svg></i></span></a><a class=level-item aria-label=twitter href=https://twitter.com/jkkitakita target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></i></span></a><a class=level-item aria-label=instagram href=https://instagram.com/jkkitakita target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"/><path d="M16 11.37A4 4 0 1112.63 8 4 4 0 0116 11.37z"/><line x1="17.5" y1="6.5" x2="17.5" y2="6.5"/></svg></i></span></a><a class=level-item aria-label=email href=mailto:jkkitakita@gmail.com target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></i></span></a><a class=level-item aria-label=linkedin href=https://linkedin.com/in/jkkitakita target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path stroke-width="1.8" d="m5.839218 4.101561c0 1.211972-.974141 2.194011-2.176459 2.194011S1.4863 5.313533 1.4863 4.101561c0-1.211094.974141-2.194011 2.176459-2.194011s2.176459.982917 2.176459 2.194011zm.017552 3.94922h-4.388022v14.04167H5.85677V8.050781zm7.005038.0H8.501869v14.04167h4.360816v-7.370999c0-4.098413 5.291077-4.433657 5.291077.0v7.370999h4.377491v-8.89101c0-6.915523-7.829986-6.66365-9.669445-3.259423V8.050781z"/></svg></i></span></a></nav></div></nav><nav class=nav></nav></div><script src=/js/navicon-shift.js></script></section><section class=section><div class=container><div class="subtitle tags is-6 is-pulled-right"><a class="subtitle is-6" href=/tags/puppet/>#puppet</a>
| <a class="subtitle is-6" href=/tags/puppet-bolt/>#puppet bolt</a></div><h2 class="subtitle is-6">December 16, 2020</h2><h1 class=title>puppet bolt のディレクトリ構成</h1><div class=content><p>この記事は <a href=https://qiita.com/advent-calendar/2020/puppet>Puppet Advent Calendar 2020 8 日目</a> の記事です。</p><ul><li><a href=#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB>はじめに</a></li><li><a href=#puppet-bolt-%E3%81%AE%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA%E6%A7%8B%E6%88%90>puppet bolt のディレクトリ構成</a></li><li><a href=#%E5%90%84%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6>各ディレクトリ・ファイルについて</a><ul><li><a href=#modules>.modules</a></li><li><a href=#resource_types>.resource_types</a></li><li><a href=#puppetfile>Puppetfile</a></li><li><a href=#bolt-debuglog>bolt-debug.log</a></li><li><a href=#bolt-projectyaml>bolt-project.yaml</a></li><li><a href=#data>data</a></li><li><a href=#hierayaml>hiera.yaml</a></li><li><a href=#inventoryyaml>inventory.yaml</a></li><li><a href=#tasks>tasks</a></li><li><a href=#site-modules>site-modules</a><ul><li><a href=#files>files</a></li><li><a href=#templates>templates</a></li><li><a href=#plans>plans</a></li></ul></li></ul></li><li><a href=#%E3%81%95%E3%81%84%E3%81%94%E3%81%AB>さいごに</a></li><li><a href=#%E5%8F%82%E8%80%83>参考</a></li></ul><h2 id=はじめに>はじめに</h2><p>まず、本記事を書こうと思ったモチベーションは</p><ul><li>puppet bolt に関する記事が足りない！！</li><li>あったとしても、1,2 年前の日本語の記事で、かつ、なんか最近の bolt と違う感じがする！！</li><li>じゃあ、公式ドキュメントだ！と思っても、実際やろうと思うと、かゆいところまでは、手が届いていない感！！</li><li>というか、puppet bolt 自体が発展途上で、そもそも色々足りない！！</li><li>puppet bolt を使いたいけど、まず、何すればいいの？</li><li>このツールの全体感がわからない。</li></ul><p>です。もし私と同様に puppet bolt を触ろうと思っている方が</p><ul><li>「あーはいはい。そんな感じで使えばいいのね。雰囲気わかった。」</li></ul><p>って状態になっていただければ、幸いです。</p><p>ただし、前置きすると、上記に記載した通り、「まだまだ発展途上感がある」と感じているため、この記事を目にした時点で、だいぶ変わっている可能性もあると思っていますので、そこのところは、ご留意ください。</p><h2 id=puppet-bolt-のディレクトリ構成>puppet bolt のディレクトリ構成</h2><p>本記事で説明する puppet bolt のディレクトリ構成は以下の通りです。それぞれに関して、簡単にですが、解説して行きたいと思います。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ tree -a -L <span style=color:#ae81ff>3</span>
.
├── .modules
│   ├── chocolatey
│   └── ...
├── .resource_types
│   └── ...
├── Puppetfile
├── README.md
├── bolt-debug.log
├── bolt-project.yaml
├── data
│   ├── common.yaml
│   ├── local.yaml
│   ├── production.yaml
│   └── staging.yaml
├── hiera.yaml
├── inventory.yaml
├── site-modules
│   └── mymodule
│       ├── files
│       │   ├── motd.txt
│       │   └── check_server.sh
│       ├── plans
│       │   ├── planA.yaml
│       │   └── planB.yaml
│       └── templates
│           └── env.epp
└── tasks
    ├── download_from_gcs.json
    └── download_from_gcs.rb
</code></pre></div><h2 id=各ディレクトリファイルについて>各ディレクトリ・ファイルについて</h2><h3 id=modules>.modules</h3><p><a href=https://forge.puppet.com/>Puppet Forge</a>の puppet modules が install されるディレクトリです。node.js でいうと node_modules 的なディレクトリです。基本的には、ここのディレクトリは、変更しない方針であることが前提で、gitignore しても問題ありません。もし修正した場合は、.gitignore しないで、含めた方がいいと思います。ちなみにここに関しては、puppet bolt を利用する上では、知らなくても、まぁなんとかなります。</p><h3 id=resource_types>.resource_types</h3><p><a href=https://forge.puppet.com/>Puppet Forge</a>の puppet modules に関連する <a href=https://puppet.com/docs/puppet/7.0/type.html>Resource Type</a> が install されるディレクトリ。基本的には、このディレクトリは、変更しない方針であることが前提で、gitignore しても問題ない。また、puppet bolt を利用する上では、知らなくても、基本問題ありません。
「<code>Resource Type</code> とはなんぞや？」というところを理解したい場合は、まずは「<code>Resource</code> とはなんぞや？」というところから、調べてみることをオススメします。</p><p>ref.</p><ul><li><a href=https://qiita.com/takeuchikzm/items/cfa012571fdedcf0792b#resource---puppet%E3%81%AB%E3%82%88%E3%82%8B%E6%A7%8B%E6%88%90%E7%AE%A1%E7%90%86%E3%81%AE%E6%9C%80%E5%B0%8F%E5%8D%98%E4%BD%8D>Resource - Puppet による構成管理の最小単位</a></li><li><a href=https://puppet.com/docs/puppet/7.0/lang_resources.html>Resources</a></li><li><a href=https://puppet.com/docs/puppet/7.0/type.html>Resource Type Reference</a></li></ul><h3 id=puppetfile>Puppetfile</h3><p><a href=https://forge.puppet.com/>Puppet Forge</a>の puppet modules を「初めて」 install した時に、作成されるファイル。基本的には、このファイルは、手で修正しない方針であることが前提（Do not edit）。このファイルをベースに、<code>.modules</code> を install するため、基本的には、gitignore はしない方がいいと個人的には思っています。ファイル名的には、<code>Gemfile</code> っぽいファイルと思いきや、<code>Gemfile.lock</code>のようなファイル。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#75715e># This Puppetfile is managed by Bolt. Do not edit.</span>
<span style=color:#75715e># For more information, see https://pup.pt/bolt-modules</span>

<span style=color:#75715e># The following directive installs modules to the managed moduledir.</span>
moduledir <span style=color:#e6db74>&#39;.modules&#39;</span>

mod <span style=color:#e6db74>&#34;puppetlabs-chocolatey&#34;</span>, <span style=color:#e6db74>&#34;5.1.1&#34;</span>
<span style=color:#960050;background-color:#1e0010>・・・</span>
</code></pre></div><h3 id=bolt-debuglog>bolt-debug.log</h3><p>Bolt コマンドを実行時、デバッグレベルのログが出力されるログファイルです。<code>bolt plan</code>などの実行ログが書き込まれます。ログの形式は以下の通りです。特に何も指定しなければ、実行毎に recreate されるため、過去のログは残らなさそうです。基本的には、<code>.gitignore</code>などで、git からは除外することが多いと思います。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt>2020-12-02T18:44:46.273566 INFO   [event-publisher] [Bolt::Outputter::Logger] Starting: plan mymodule::planA
2020-12-02T18:44:46.291736 INFO   [event-publisher] [Bolt::Outputter::Logger] Finished: plan mymodule::planA in 0.02 sec
</code></pre></div><p>ref. <a href=https://puppet.com/docs/bolt/latest/logs.html#the-bolt-debuglog-file>The bolt-debug.log file</a></p><h3 id=bolt-projectyaml>bolt-project.yaml</h3><p>project 単位（リポジトリ単位？）で、bolt の設定を管理する時に用意するファイル。ansible でいうところの ansible.cfg みたいなもの。今までは、<code>bolt.yaml</code>を使っていたみたいですが、そちらは非推奨になっています。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># bolt project の作成（ project_name に、ハイフンは含められない。）</span>
$ bolt project init myproject

$ ls
bolt-project.yaml

$ cat bolt-project.yaml
---
name: myproject
</code></pre></div><p>ref. <a href=https://puppet.com/docs/bolt/latest/bolt_project_reference.html>bolt-project.yaml options</a></p><h3 id=data>data</h3><p>bolt で利用する変数などを管理するディレクトリ。一般的には、OS や環境毎や構成管理ツール毎などの yaml ファイルを格納しておくことが多いです。後述する hiera の機能で、その変数等を読み込む優先順位を定義します。格納できるファイルは、YAML or JSON or HOCON（Human-Optimized Config Object Notation）が利用できます。ディレクトリ名は <code>data</code> である必要はありませんが、大体、 <code>data</code> とすることが多いようです。簡単な yaml の例を記載するとすると以下のような形で、普通の yaml として定義するだけです。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#75715e># staging.yaml</span>
---
<span style=color:#f92672>gcp_project_id</span>: <span style=color:#e6db74>&#34;gcp_project_staging&#34;</span>

<span style=color:#75715e># production.yaml</span>
---
<span style=color:#f92672>gcp_project_id</span>: <span style=color:#e6db74>&#34;gcp_project_production&#34;</span>
</code></pre></div><p>ref. <a href=https://puppet.com/docs/puppet/7.1/hiera_merging.html>Creating and editing data</a></p><h3 id=hierayaml>hiera.yaml</h3><p><code>data</code> ディレクトリに格納した変数ファイルの読み込む優先順位などを定義するファイル。 <code>hierarchy</code> に、ハッシュの配列形式で読み込む順番（優先順位）を定義する。上から下に、優先順位が下がっていきます。そのため基本的には、最後に、<code>common.yaml</code> とかを記載することが多いです。ansible だと、<code>group_vars</code> とか <code>host_vars</code> とか暗黙的な変数定義ルールがある印象ですが、多分？、puppet bolt の変数定義ルールはここに全て記載する必要があるような気がしています。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>---
<span style=color:#f92672>version</span>: <span style=color:#ae81ff>5</span> <span style=color:#75715e># hiera の ver 指定する。bolt は ver 5のみ対応している。</span>
<span style=color:#f92672>defaults</span>:
  <span style=color:#f92672>datadir</span>: <span style=color:#ae81ff>data</span> <span style=color:#75715e># 変数ファイルを、hiera.yaml ファイルからみた相対パスで指定する</span>
  <span style=color:#f92672>data_hash</span>: <span style=color:#ae81ff>yaml_data</span> <span style=color:#75715e># 変数ファイルの形式を指定する。e.g. yaml, json, HOCON</span>

<span style=color:#f92672>hierarchy</span>:
  <span style=color:#75715e># bolt 実行時に、env を渡すとそれぞれの変数ファイルを読み込む</span>
  <span style=color:#75715e># 上から優先順位が高い。そのため基本的には、最後に、common.yamlとかを記載することが多い。</span>
  - <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;environment data&#34;</span>
    <span style=color:#f92672>path</span>: <span style=color:#e6db74>&#34;%{env}.yaml&#34;</span>
  - <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;common data&#34;</span>
    <span style=color:#f92672>path</span>: <span style=color:#e6db74>&#34;common.yaml&#34;</span>
</code></pre></div><p>上記 hiera.yaml を定義した場合、下記のように bolt plan 実行時に、引数に<code>env</code>実行すると、各環境の変数ファイルを読み込むことが可能です。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># 引数 env=staging -&gt; data/staging.yaml を読み込む</span>
$ bolt plan run mymodule::planA env<span style=color:#f92672>=</span>staging --targets webservers

<span style=color:#75715e># 引数 env=production -&gt; data/production.yaml を読み込む</span>
$ bolt plan run mymodule::planA env<span style=color:#f92672>=</span>production --targets webservers
</code></pre></div><p>ref.</p><ul><li><a href=https://qiita.com/takeuchikzm/items/e04e6cbe84a185eb1f26>私と Puppet ベストプラクティス編 その 3 (Hiera で世界が変わる?)</a></li><li><a href=https://puppet.com/docs/puppet/7.0/hiera_config_yaml_5.html>Configuring Hiera</a></li></ul><h3 id=inventoryyaml>inventory.yaml</h3><p>対象ホストを管理するファイルです。ansbible の inventory ファイルと同様の役割をするファイルです。<a href=https://puppet.com/docs/bolt/latest/inventory_file_v2.html>Inventory files</a>にある、一部の例を下記に転記しました。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>groups</span>:
  <span style=color:#75715e># e.g. linux の webserver via ssh</span>
  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>ssh_nodes</span>
    <span style=color:#f92672>groups</span>:
      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>webservers</span>
        <span style=color:#f92672>targets</span>:
          - <span style=color:#ae81ff>192.168.100.179</span>
          - <span style=color:#ae81ff>192.168.100.180</span>
      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>memcached</span>
        <span style=color:#f92672>targets</span>:
          - <span style=color:#ae81ff>192.168.101.50</span>
        <span style=color:#f92672>config</span>:
          <span style=color:#f92672>ssh</span>:
            <span style=color:#f92672>user</span>: <span style=color:#ae81ff>root</span>
    <span style=color:#f92672>config</span>:
      <span style=color:#f92672>transport</span>: <span style=color:#ae81ff>ssh</span>
      <span style=color:#f92672>ssh</span>:
        <span style=color:#f92672>user</span>: <span style=color:#ae81ff>centos</span>
        <span style=color:#f92672>private-key</span>: <span style=color:#ae81ff>~/.ssh/id_rsa</span>
        <span style=color:#f92672>host-key-check</span>: <span style=color:#66d9ef>false</span>
  <span style=color:#75715e># e.g. windows の webservers via winrm</span>
  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>win_nodes</span>
    <span style=color:#f92672>groups</span>:
      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>apiservers</span>
        <span style=color:#f92672>targets</span>:
          - <span style=color:#ae81ff>192.168.110.10</span>
      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>testservers</span>
        <span style=color:#f92672>targets</span>:
          - <span style=color:#ae81ff>172.16.219.20</span>
    <span style=color:#f92672>config</span>:
      <span style=color:#f92672>transport</span>: <span style=color:#ae81ff>winrm</span>
      <span style=color:#f92672>winrm</span>:
        <span style=color:#f92672>user</span>: <span style=color:#ae81ff>DOMAIN\opsaccount</span>
        <span style=color:#f92672>password</span>: <span style=color:#ae81ff>S3cretP@ssword</span>
        <span style=color:#f92672>ssl</span>: <span style=color:#66d9ef>true</span>
</code></pre></div><p>ここの例では、まず、接続方式が、「ssh」か「<a href=https://qiita.com/asterisk9101/items/46d45c30a1141b1e6115>winrm</a>」かで group を分けています。その後、それぞれで、複数対象ホストが存在する場合は、さらに、groups で入れ子にして、対象ホストを指定します。config には、接続方式とその認証情報を記載します。そして、bolt コマンド実行時の <code>--targets</code> の引数として、groups を指定するように、下記のようなコマンドを実行します。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># ssh_nodes,win_nodes 両方に実行する場合</span>
$ bolt command run <span style=color:#e6db74>&#39;echo hello&#39;</span> --targets ssh_nodes,win_nodes

<span style=color:#75715e># ssh_nodes のみに実行する場合</span>
$ bolt command run <span style=color:#e6db74>&#39;echo hello&#39;</span> --targets ssh_nodes

<span style=color:#75715e># webservers,testservers のみに実行する場合</span>
$ bolt command run <span style=color:#e6db74>&#39;echo hello&#39;</span> --targets webservers,testservers
</code></pre></div><p>そうすると、inventory から指定された targets への接続方法・情報を判断して、それぞれに対して、接続し、コマンドを実行します。ただし、この指定の仕方の場合、<code>targets</code>に対して、IP アドレスなどを指定しなければならないため、対象ホストが増えてくると管理が煩雑になっていきます。もし設計段階で、そのような状況になりそうであれば、AWS や GCP などのクラウドを使っているのであれば、いわゆる <a href=https://puppet.com/docs/bolt/latest/inventory_file_v2.html#plugins>Dynamic Inventory</a> のような plugin 機能を利用するのは簡単にできそうなため、試してみるのが良いかなと思います。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#75715e># ref. https://forge.puppet.com/modules/puppetlabs/aws_inventory</span>

<span style=color:#75715e># inventory.yaml</span>
---
<span style=color:#f92672>groups</span>:
  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>aws</span>
    <span style=color:#f92672>targets</span>:
      - <span style=color:#f92672>_plugin</span>: <span style=color:#ae81ff>aws_inventory</span>
        <span style=color:#f92672>profile</span>: <span style=color:#ae81ff>user1</span>
        <span style=color:#f92672>region</span>: <span style=color:#ae81ff>us-west-1</span>
        <span style=color:#f92672>filters</span>:
          - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>tag:Owner</span>
            <span style=color:#f92672>values</span>: [<span style=color:#ae81ff>Devs]</span>
          - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>instance-type</span>
            <span style=color:#f92672>values</span>: [<span style=color:#ae81ff>t2.micro, c5.large]</span>
        <span style=color:#f92672>target_mapping</span>:
          <span style=color:#f92672>name</span>: <span style=color:#ae81ff>public_dns_name</span>
          <span style=color:#f92672>uri</span>: <span style=color:#ae81ff>public_ip_address</span>
          <span style=color:#f92672>config</span>:
            <span style=color:#f92672>ssh</span>:
              <span style=color:#f92672>host</span>: <span style=color:#ae81ff>public_dns_name</span>
    <span style=color:#f92672>config</span>:
      <span style=color:#f92672>ssh</span>:
        <span style=color:#f92672>user</span>: <span style=color:#ae81ff>ec2-user</span>
        <span style=color:#f92672>private-key</span>: <span style=color:#ae81ff>~/.aws/private-key.pem</span>
        <span style=color:#f92672>host-key-check</span>: <span style=color:#66d9ef>false</span>
</code></pre></div><p>ref. <a href=https://puppet.com/docs/bolt/latest/inventory_file_v2.html>Inventory files</a></p><h3 id=tasks>tasks</h3><p>task は、対象ホストで実行する puppet bolt の中で最もシンプルなアクションの単位です。タスクは、Bash、Python、Ruby など、対象ホスト似て、実行できる任意のプログラミング言語でタスクを記述できます。デフォルトでは、下記のようなタスクが用意されています。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ bolt task show

apt                                 Allows you to perform apt functions
facts                               Gather system facts
http_request                        Make a HTTP or HTTPS request.
package                             Manage and inspect the state of packages
pkcs7::secret_createkeys            Create a key pair
pkcs7::secret_decrypt               Encrypt sensitive data with pkcs7
pkcs7::secret_encrypt               Encrypt sensitive data with pkcs7
puppet_agent::install               Install the Puppet agent package
puppet_agent::version               Get the version of the Puppet agent package installed. Returns nothing <span style=color:#66d9ef>if</span> none present.
puppet_conf                         Inspect puppet agent configuration settings
reboot                              Reboots a machine
reboot::last_boot_time              Gets the last boot time of a Linux or Windows system
service                             Manage and inspect the state of services
terraform::apply                    Apply an HCL manifest
terraform::destroy                  Destroy resources managed with Terraform
terraform::initialize               Initialize a Terraform project directory
terraform::output                   JSON representation of Terraform outputs
</code></pre></div><p>例えば、package のタスクの使い方としては、以下のコマンドを実行することで、対象ホスト（webservers）の Apache の status を確認することができます。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>bolt task run package action<span style=color:#f92672>=</span>status name<span style=color:#f92672>=</span>apache2 --targets webservers
</code></pre></div><p>カスタムタスクの例として、ruby で記載した GCS からファイルをダウンロードするタスクを紹介します。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>・・・
└── tasks
    ├── download_from_gcs.json <span style=color:#75715e># タスクのメタデータ</span>
    └── download_from_gcs.rb   <span style=color:#75715e># タスクを定義する実行スクリプト</span>
</code></pre></div><p>ファイルとしては、「タスクのメタデータ」の json と「タスクを定義する実行スクリプト」を準備します。そして、それぞれのファイルを以下のように記述します。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#960050;background-color:#1e0010>//</span> <span style=color:#960050;background-color:#1e0010>download_from_gcs.json</span>
{
  <span style=color:#f92672>&#34;description&#34;</span>: <span style=color:#e6db74>&#34;Download file from google cloud storage locally&#34;</span>, <span style=color:#960050;background-color:#1e0010>//</span> <span style=color:#960050;background-color:#1e0010>タスクの説明</span>
  <span style=color:#f92672>&#34;input_method&#34;</span>: <span style=color:#e6db74>&#34;stdin&#34;</span>, <span style=color:#960050;background-color:#1e0010>//</span> <span style=color:#960050;background-color:#1e0010>タスクのインプット方法</span> <span style=color:#960050;background-color:#1e0010>e.g.</span> <span style=color:#960050;background-color:#1e0010>environment（環境変数）,</span> <span style=color:#960050;background-color:#1e0010>stdin（標準入力）,</span> <span style=color:#960050;background-color:#1e0010>powershell（？？）</span>
  <span style=color:#f92672>&#34;parameters&#34;</span>: {
    <span style=color:#f92672>&#34;bucket_name&#34;</span>: {
      <span style=color:#f92672>&#34;description&#34;</span>: <span style=color:#e6db74>&#34;Bucket of google cloud storage&#34;</span>, <span style=color:#960050;background-color:#1e0010>//</span> <span style=color:#960050;background-color:#1e0010>パラメータの説明</span>
      <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;String[1]&#34;</span> <span style=color:#960050;background-color:#1e0010>//</span> <span style=color:#960050;background-color:#1e0010>パラメータのデータ型の指定</span> <span style=color:#960050;background-color:#1e0010>e.g.</span> <span style=color:#960050;background-color:#1e0010>空ではない文字列</span>
    },
    <span style=color:#f92672>&#34;object_path&#34;</span>: {
      <span style=color:#f92672>&#34;description&#34;</span>: <span style=color:#e6db74>&#34;Object path of google cloud storage&#34;</span>,
      <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;String[1]&#34;</span>
    },
    <span style=color:#f92672>&#34;tmp_dir&#34;</span>: {
      <span style=color:#f92672>&#34;description&#34;</span>: <span style=color:#e6db74>&#34;tmp path&#34;</span>,
      <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;String[1]&#34;</span>
    }
  },
  <span style=color:#f92672>&#34;files&#34;</span>: [<span style=color:#e6db74>&#34;ruby_task_helper/files/task_helper.rb&#34;</span>] <span style=color:#960050;background-color:#1e0010>//</span> <span style=color:#960050;background-color:#1e0010>タスク実行時に利用するファイルの指定。基本、ヘルパーライブラリが多いかも。</span>
}
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#75715e>#!/usr/bin/env ruby</span>

require_relative <span style=color:#e6db74>&#39;../../ruby_task_helper/files/task_helper&#39;</span>
require <span style=color:#e6db74>&#39;google/cloud/storage&#39;</span>

<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DownloadFileFromGCS</span> <span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>TaskHelper</span>
  <span style=color:#75715e># GCSの指定バケット・オブジェクトパスを指定tmpディレクトリにダウンロードするタスク</span>
  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>task</span>(<span style=color:#e6db74>bucket_name</span>: <span style=color:#66d9ef>nil</span>, <span style=color:#e6db74>object_path</span>: <span style=color:#66d9ef>nil</span>, <span style=color:#e6db74>tmp_dir</span>: <span style=color:#66d9ef>nil</span>, <span style=color:#f92672>**</span>_kwargs)
    storage <span style=color:#f92672>=</span> <span style=color:#66d9ef>Google</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Cloud</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Storage</span><span style=color:#f92672>.</span>new
    bucket <span style=color:#f92672>=</span> storage<span style=color:#f92672>.</span>bucket bucket_name
    object <span style=color:#f92672>=</span> bucket<span style=color:#f92672>.</span>file object_path
    object<span style=color:#f92672>.</span>download tmp_dir <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;/&#39;</span> <span style=color:#f92672>+</span> object_path

    puts <span style=color:#e6db74>&#34;Success to download </span><span style=color:#e6db74>#{</span>object<span style=color:#f92672>.</span>name<span style=color:#e6db74>}</span><span style=color:#e6db74> to </span><span style=color:#e6db74>#{</span>tmp_dir<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
  <span style=color:#66d9ef>end</span>
<span style=color:#66d9ef>end</span>

<span style=color:#66d9ef>DownloadFileFromGCS</span><span style=color:#f92672>.</span>run <span style=color:#66d9ef>if</span> __FILE__ <span style=color:#f92672>==</span> $0
</code></pre></div><p>上記カスタムタスクは、<code>ruby_task_helper</code>を利用しています。名前の通り、ruby でカスタムタスクを作成する際に、いい感じにしてくれる、ruby のヘルパーライブラリです。ざっくりいうと、メタデータにパラメータを指定して、スクリプトの方で、メソッドを定義すればよい。それだけと言えばそれだけです。</p><p>ref. <a href=https://puppet.com/docs/bolt/latest/writing_tasks.html#common-task-data-types>利用できるタスクのデータ型</a></p><p>タスクの詳細は以下のように確認することもできます。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ bolt task show myproject::download_from_gcs

myproject::download_from_gcs - Download file from google cloud storage locally

USAGE:
bolt task run --targets &lt;node-name&gt; myproject::download_from_gcs bucket_name<span style=color:#f92672>=</span>&lt;value&gt; object_path<span style=color:#f92672>=</span>&lt;value&gt; tmp_dir<span style=color:#f92672>=</span>&lt;value&gt;

PARAMETERS:
- bucket_name: String<span style=color:#f92672>[</span>1<span style=color:#f92672>]</span>
    Bucket of google cloud storage
- object_path: String<span style=color:#f92672>[</span>1<span style=color:#f92672>]</span>
    Object path of google cloud storage
- tmp_dir: String<span style=color:#f92672>[</span>1<span style=color:#f92672>]</span>
    tmp path

MODULE:
/Users/jkkitakita/myproject
</code></pre></div><p>あとは、定義した task を直接使う、または、plan から呼び出せば ok です。</p><p>ref. <a href=https://puppet.com/docs/bolt/latest/tasks.html>Making on-demand changes with tasks</a></p><h3 id=site-modules>site-modules</h3><p>最後に、site-modules を紹介します。site-modules は、プロジェクト毎の custom modules です。（ドキュメントがいまいちないので、合ってるか不明。私の認識です。）<a href=https://forge.puppet.com/>Puppet Forge</a>の puppet modules は、<code>.modules</code> に格納されると上述しましたが、それでは不十分である、または、プロダクト固有の modules を作成したい場合に用意します。その際には、<code>site-modules</code> ディレクトリを作成します。シンプルな plan を実行したいだけであれば、 bolt project のルートディレクトリに <code>plan</code> ディレクトリを作成するだけで十分かもしれません。が、個人的には、ちゃんと今後の保守・運用も考慮するのであれば、単純な plan を実行するだけでも <code>site-modules</code> ディレクトリを作成した方がいいと思います。ansible でいうと、<code>modules</code> を <code>roles</code> に読み替えると良いかもしません。<code>Puppet Forge</code> は <code>Ansible Galaxy</code>的な立ち位置なので、ansible に慣れている方は、そのイメージです。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># puppet bolt の site-modules のディレクトリ構成</span>
...
├── site-modules
│   └── mymodule
│       ├── files
│       ├── plans
│       └── templates
...
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># ref. ansible の場合の roles のディレクトリ構成</span>
...
├── roles
│   └── myrole
│       ├── files
│       ├── tasks
│       └── templates
...
</code></pre></div><p>ただし、実際に使ってみた感覚から言うと、ansible の roles よりも、もう少し柔軟な（悪くいうと、フワッとした）custom modules を定義できる印象があります。具体的には</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># puppet bolt の site-modules のディレクトリ構成</span>
...
├── site-modules
│   └── mymodule
│       └── plans
│           ├── planA.yaml
│           └── planB.yaml
...
</code></pre></div><p>と定義した場合</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># planA を実行したい場合</span>
$ bolt plan run mymodule::planA --targets webservers
<span style=color:#75715e># planB を実行したい場合</span>
$ bolt plan run mymodule::planB --targets webservers
</code></pre></div><p>のような形で、指定できるため、ざっくりと、サービス単位とかで、custom modules を設計することも可能です。何が言いたいかというと、ansible の場合、tasks を実行する際、 <code>tasks/main.yaml</code> から実行される縛りがあるのですが、その縛りはないということです。ただ、一般的に他の puppet bolt のリポジトリを見た感じだと、ansible の roles と同様に、<code>nginx</code>とか<code>deploy</code>とかの単位で分けているところが多そうには感じました。下記のリポジトリなどが参考になるかもしれません。</p><p><a href=https://github.com/puppetlabs-seteam/control-repo>https://github.com/puppetlabs-seteam/control-repo</a></p><p>以下、site-modules 配下の <code>files</code>、<code>plans</code>、<code>templates</code>の 3 つのディレクトリに関してのみ解説しようと思います。その他に関しては、<a href=https://puppet.com/docs/bolt/latest/module_structure.html>Module structure</a>を参考にしてください。<br>※ ただし、上記、<code>Module structure</code>で紹介されているディレクトリ・ファイルが、<code>site-modules</code>が対応しているかどうかは調べていません。全然 <code>site-modules</code> に関するドキュメントがない。。）</p><p>ref. <a href=https://puppet.com/docs/bolt/latest/writing_plans.html#plan-location>Plan location</a> の一部に <code>site-modules</code> に関して記述されています。</p><h4 id=files>files</h4><p>plan 実行時に、「対象ホストに、静的ファイルを upload する」「対象ホスト上で、静的スクリプトを実行する」などの場合に、その静的ファイル・スクリプトを格納するディレクトリです。ansible でも同様に <code>files</code> ディレクトリを使っていますが、それと使い方は同じです。実際の bolt の plan ファイルの syntax は下記のような形になります。<code>site-modules</code>や<code>files</code>などは無視して、<code>mymodule/motd.txt</code>と指定するところが少しややこしさがあるかもしれません。が、一応、他 modules の files も指定できますよ。ってことなのかなと思っています。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>steps</span>:
  <span style=color:#75715e># motd.txt を対象ホストに upload する</span>
  - <span style=color:#f92672>upload</span>: <span style=color:#ae81ff>mymodule/motd.txt</span> <span style=color:#75715e># ref. site-modules/mymodule/files/motd.txt</span>
    <span style=color:#f92672>destination</span>: <span style=color:#ae81ff>/etc/motd</span>
    <span style=color:#f92672>targets</span>: <span style=color:#ae81ff>$targets</span>
    <span style=color:#f92672>description</span>: <span style=color:#e6db74>&#34;Upload motd to the webservers&#34;</span>
  <span style=color:#75715e># check_server.sh を対象ホスト上で実行する</span>
  <span style=color:#75715e># e.g. ./check_server.sh /index.html 60</span>
  - <span style=color:#f92672>script</span>: <span style=color:#ae81ff>mymodule/check_server.sh</span>
    <span style=color:#f92672>targets</span>: <span style=color:#ae81ff>$targets</span>
    <span style=color:#f92672>description</span>: <span style=color:#e6db74>&#34;Run mymodule/files/check_server.sh on the webservers&#34;</span>
    <span style=color:#f92672>arguments</span>: <span style=color:#75715e># Optional</span>
      - <span style=color:#e6db74>&#34;/index.html&#34;</span>
      - <span style=color:#ae81ff>60</span>
</code></pre></div><p>ref.</p><ul><li><a href=https://puppet.com/docs/bolt/latest/writing_yaml_plans.html#script-step>Writing plans in YAML#Script step</a></li><li><a href=https://puppet.com/docs/bolt/latest/writing_yaml_plans.html#file-download-step>Writing plans in YAML#File download step</a></li><li><a href=https://puppet.com/docs/bolt/latest/writing_yaml_plans.html#file-upload-step>Writing plans in YAML#File upload step</a></li></ul><h4 id=templates>templates</h4><p>templates は、files と違い、動的に変数等を代入して、最終的にレンダリングされたファイルを生成したいファイルを管理するディレクトリです。こちらも ansible の templates と同様の用途です。ansible の場合は、python 製のため、基本的に jinja2 がテンプレートエンジンとして利用されていますが、Puppet の場合は、<a href=https://puppet.com/docs/puppet/5.5/lang_template_epp.html>Embedded Puppet（EPP）</a>、もしくは、<a href=https://puppet.com/docs/puppet/5.5/lang_template_erb.html>Embedded Ruby (ERB)</a>で記述する必要があります。以下、結論を記載します。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-pp data-lang=pp><span style=color:#75715e># mymodules/templates/env.epp</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>%</span><span style=color:#f92672>-</span> <span style=color:#f92672>|</span> <span style=color:#a6e22e>String</span>  $env,<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>      <span style=color:#a6e22e>String</span>  $gcp_project_id,<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#f92672>|</span> <span style=color:#f92672>-</span><span style=color:#960050;background-color:#1e0010>%</span><span style=color:#f92672>&gt;</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#a6e22e>ENV</span><span style=color:#f92672>=&lt;</span><span style=color:#960050;background-color:#1e0010>%</span><span style=color:#f92672>=</span> $env <span style=color:#960050;background-color:#1e0010>%</span><span style=color:#f92672>&gt;</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#a6e22e>GCP_PROJECT_ID</span><span style=color:#f92672>=&lt;</span><span style=color:#960050;background-color:#1e0010>%</span><span style=color:#f92672>=</span> $gcp_project_id <span style=color:#960050;background-color:#1e0010>%</span><span style=color:#f92672>&gt;</span><span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-pp data-lang=pp><span style=color:#75715e># mymodules/plans/planB.pp
</span><span style=color:#75715e>#
</span><span style=color:#75715e>#/tmp/.env ファイルを更新する plan
</span><span style=color:#75715e># @param targets The targets to configure
</span><span style=color:#75715e># @param env The environment
</span><span style=color:#75715e># @param tmp_dir The tmp directory for download destination</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#a6e22e>plan</span> <span style=color:#a6e22e>mymodule</span>::<span style=color:#a6e22e>planB</span>(<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#a6e22e>TargetSpec</span> $targets,<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#a6e22e>String</span>[<span style=color:#ae81ff>1</span>] $env,<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#a6e22e>String</span>[<span style=color:#ae81ff>1</span>] $tmp_dir <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;/tmp&#39;</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>) {<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#a6e22e>apply</span>($targets) {<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#66d9ef>file</span> { <span style=color:#e6db74>&#34;${tmp_dir}/.env&#34;</span>:<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>      <span style=color:#a6e22e>content</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>epp</span>(<span style=color:#e6db74>&#39;mymodules/env.epp&#39;</span>, {<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>        <span style=color:#e6db74>&#39;env&#39;</span>            <span style=color:#f92672>=&gt;</span> $env,<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>        <span style=color:#e6db74>&#39;gcp_project_id&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>lookup</span>(<span style=color:#e6db74>&#39;gcp_project_id&#39;</span>),<span style=color:#75715e> # hiera の data を取得</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>      }),<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    }<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>  }<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>上記は、それぞれ <code>mymodules/templates/env.epp</code> と <code>mymodules/plans/planB.pp</code> で記載した template と plan（Puppet 言語）です。これで、下記コマンドを実行してみると</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>bolt plan run mymodules::planB env<span style=color:#f92672>=</span>staging --targets webservers
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>centos@192.168.100.179$ cat /tmp/.env

ENV<span style=color:#f92672>=</span>staging
GCP_PROJECT_ID<span style=color:#f92672>=</span>gcp_project_staging
</code></pre></div><p>となります。この際、<code>lookup('gcp_project_id')</code>と指定して、<code>gcp_project_staging</code>が代入されています。これは puppet の build-in function <a href=https://puppet.com/docs/puppet/7.1/function.html#lookup>lookup</a> を使うことで、hiera data として定義した変数を取得することができるためです。</p><p>ref.</p><ul><li><a href=https://puppet.com/docs/puppet/5.5/lang_template.html>Language: Using templates</a></li><li><a href=https://puppet.com/docs/bolt/latest/applying_manifest_blocks.html#using-hiera-data-in-a-manifest-block>Applying Puppet code#Using Hiera data in a manifest block</a></li></ul><h4 id=plans>plans</h4><p>bolt の plan を格納するディレクトリです。plan は、複数のタスクを一まとまりにした単位のことを呼びます。実行したタスクの入力の値を計算したり、別のタスクの結果に基づいて特定のタスクを実行したりするなど、複雑なタスクを実行できます。plan は、yaml（not .yml） or puppet（pp）で記述することが可能です。それぞれ同じで、同じタスクを記述すると</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#75715e># yaml の場合（site-modules/mymodule/plans/planA.yaml）</span>
<span style=color:#f92672>parameters</span>:
  <span style=color:#f92672>targets</span>:
    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>TargetSpec</span>
  <span style=color:#f92672>bucket_name</span>:
    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>String[1]</span>
  <span style=color:#f92672>object_path</span>:
    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>String[1]</span>
  <span style=color:#f92672>tmp_dir</span>:
    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>String[1]</span>
    <span style=color:#f92672>default</span>: <span style=color:#e6db74>&#34;/tmp&#34;</span>

<span style=color:#f92672>steps</span>:
  <span style=color:#75715e># motd.txt を対象ホストに upload する</span>
  - <span style=color:#f92672>upload</span>: <span style=color:#ae81ff>mymodule/motd.txt</span> <span style=color:#75715e># ref. site-modules/mymodule/files/motd.txt</span>
    <span style=color:#f92672>destination</span>: <span style=color:#ae81ff>/etc/motd</span>
    <span style=color:#f92672>targets</span>: <span style=color:#ae81ff>$targets</span>
    <span style=color:#f92672>description</span>: <span style=color:#e6db74>&#34;Upload motd to the webservers&#34;</span>
  <span style=color:#75715e># check_server.sh を対象ホスト上で実行する</span>
  <span style=color:#75715e># e.g. ./check_server.sh /index.html 60</span>
  - <span style=color:#f92672>script</span>: <span style=color:#ae81ff>mymodule/check_server.sh</span>
    <span style=color:#f92672>targets</span>: <span style=color:#ae81ff>$targets</span>
    <span style=color:#f92672>description</span>: <span style=color:#e6db74>&#34;Run mymodule/files/check_server.sh on the webservers&#34;</span>
    <span style=color:#f92672>arguments</span>: <span style=color:#75715e># Optional</span>
      - <span style=color:#e6db74>&#34;/index.html&#34;</span>
      - <span style=color:#ae81ff>60</span>
  - <span style=color:#f92672>task</span>: <span style=color:#ae81ff>myproject::download_from_gcs</span>
    <span style=color:#f92672>targets</span>: <span style=color:#ae81ff>$targets</span>
    <span style=color:#f92672>description</span>: <span style=color:#e6db74>&#34;Download file from gcs&#34;</span>
    <span style=color:#f92672>parameters</span>:
      <span style=color:#f92672>bucket_name</span>: <span style=color:#ae81ff>$bucket_name</span>
      <span style=color:#f92672>object_path</span>: <span style=color:#ae81ff>$object_path</span>
      <span style=color:#f92672>tmp_dir</span>: <span style=color:#ae81ff>$tmp_dir</span>
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-pp data-lang=pp><span style=color:#75715e># puppuet の場合（site-modules/mymodule/plans/planA.pp）
</span><span style=color:#75715e>
</span><span style=color:#75715e># @param targets The targets to configure
</span><span style=color:#75715e># @param bucket_name The bucket name
</span><span style=color:#75715e># @param object_path The object path
</span><span style=color:#75715e># @param tmp_dir The tmp directory for download destination</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#a6e22e>plan</span> <span style=color:#a6e22e>mymodule</span>::<span style=color:#a6e22e>planA</span>(<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#a6e22e>TargetSpec</span> $targets,<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#a6e22e>String</span>[<span style=color:#ae81ff>1</span>] $bucket_name,<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#a6e22e>String</span>[<span style=color:#ae81ff>1</span>] $object_path,<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#a6e22e>String</span>[<span style=color:#ae81ff>1</span>] $tmp_dir <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;/tmp&#39;</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>) {<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#a6e22e>upload_file</span>(<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#e6db74>&#39;mymodule/motd.txt&#39;</span>,<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#e6db74>&#39;/etc/motd&#39;</span>,<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    $targets,<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#e6db74>&#34;Upload motd to the webservers&#34;</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>  )<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#a6e22e>run_script</span>(<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#e6db74>&#39;mymodule/check_server.sh&#39;</span>,<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    $targets,<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#e6db74>&#34;Run mymodule/files/check_server.sh on the webservers&#34;</span>,<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    {<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>      <span style=color:#e6db74>&#39;arguments&#39;</span> <span style=color:#f92672>=&gt;</span> [<span style=color:#e6db74>&#34;/index.html&#34;</span>, <span style=color:#ae81ff>60</span>]<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    }<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>  )<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#a6e22e>run_task</span>(<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#e6db74>&#39;myproject::download_from_gcs&#39;</span>,<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    $targets,<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#e6db74>&#39;Download file from gcs&#39;</span>,<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    {<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>      <span style=color:#e6db74>&#39;bucket_name&#39;</span> <span style=color:#f92672>=&gt;</span> $bucket_name,<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>      <span style=color:#e6db74>&#39;object_path&#39;</span> <span style=color:#f92672>=&gt;</span> $object_path,<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>      <span style=color:#e6db74>&#39;tmp_dir&#39;</span>     <span style=color:#f92672>=&gt;</span> $tmp_dir,<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    },<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>  )<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>となります。上記 2 つの plan は同じ plan です。細かい箇所の説明は省きますが、上記のように記述したのち</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>bolt plan run mymodule::planA env<span style=color:#f92672>=</span>staging bucket_name<span style=color:#f92672>=</span>mybucket object_path<span style=color:#f92672>=</span>myobject.txt --targets webservers
</code></pre></div><p>のコマンドを実行することで、対象ホスト（targets）に対して、plan を実行することができます。ちなみに余談ですが、下記コマンドを実行すると、<code>yaml -> pp</code> への変換ができます。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>bolt plan convert site-modules/mymodule/plans/planA.yaml
</code></pre></div><p>そこで次に考えるのは、<code>yaml</code>と<code>pp</code>どっちで書こう問題なのですが、「やっぱり yaml の方が慣れてる人多いし、puppet 独自の DSL とか学習コスト高そうだし、やっぱり yaml で書こう！」と、Puppet 言語に慣れていないほとんどの人が思うところかなと思うのですが、ここで割と大事な個人的な見解としては、<code>「（現時点では）ちゃんと本番環境で利用とするのであれば、多少苦労してでも、Puppet言語で記述した方がいい」</code>です。なぜかというと、<code>yaml だと、まだ動かないこと結構多いです。</code>最も致命的なのは、<code>templateがいまいち使えない</code>ことです。（ref. <a href=https://github.com/puppetlabs/bolt/issues/2301>Support Templates from yaml #2301</a>） やはり、前身となるのが Puppet 言語なので、現段階では、「今まで、Puppet 言語で作られてきたものを YAML でも書けるようにするために色々頑張ってる」という印象が強いです。そのため現段階での個人的な見解としては、あまり yaml で記述することをお勧めしません。</p><h2 id=さいごに>さいごに</h2><p>他の構成管理ツールを使ったことがある方なら、やはりディレクトリ構成も似ていたりするので、割と取っつきやすい部分もありますが、「独自言語であること」「落とし穴がある」「ドキュメント・ナレッジが少ない」の 3 つがやはりネックになってきます。上記記載したことを参考にしていただきなら、まずは、触ってみる。その中で、全体のコンセプトを掴んでもらい、設計 -> 実装とやると良いかなと思います。今後はもっと、Puppet Bolt が流行ってくることを期待したいです。</p><h2 id=参考>参考</h2><ul><li><a href=https://puppet.com/docs/bolt/latest/bolt.html>Welcome to Bolt</a></li><li>その他に関しては、各項目毎の <code>ref</code> を参考にしてください。</li></ul><div class=related><h3>Similar articles:</h3><ul><li><a href=/post/202012012340/>puppet bolt とは</a></li><li><a href=/post/202006051635/>k8sとGKEのサポートバージョンの違いに関するメモ</a></li><li><a href=/post/202003291728/>Japan Rook Meetup #2</a></li><li><a href=/post/202002051855/>Terraform meetup tokyo#4</a></li><li><a href=/post/202001291937/>Kubernetes Meetup Tokyo #27</a></li></ul></div></div></div></section><script src=/js/copycode.js></script><section class=section><div class="container has-text-centered"><p>(C) <a href=https://github.com/jkkitakita>Jun Kitamura</a> 2020</p></div></section><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-156067080-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript>var _paq=_paq||[];_paq.push(['trackPageView']);_paq.push(['enableLinkTracking']);(function(){var u="\/\/matomo.example.com\/";_paq.push(['setTrackerUrl',u+'piwik.php']);_paq.push(['setSiteId','1']);var d=document,g=d.createElement('script'),s=d.getElementsByTagName('script')[0];g.type='text/javascript';g.async=true;g.defer=true;g.src=u+'piwik.js';s.parentNode.insertBefore(g,s);})();</script><noscript><img src="//matomo.example.com/piwik.php?idsite=1&rec=1" style=border:0 alt></noscript></body></html>