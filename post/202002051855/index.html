<!doctype html><html xmlns=http://www.w3.org/1999/xhtml lang=ja><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Terraform meetup tokyo#4 | jkkitakita</title><meta property="og:title" content="Terraform meetup tokyo#4 - jkkitakita"><meta property="og:description" content="Terraform meetup tokyo#4"><meta property="og:url" content="https://blog.jkkitakita.dev/post/202002051855/"><meta property="og:site_name" content="jkkitakita"><meta property="og:type" content="article"><meta property="og:image" content="https://www.gravatar.com/avatar/23c25c7545ad2fdbdbab1f9201bf96b7?s=256"><meta property="article:author" content="https://facebook.com/jkkitakita"><meta property="article:section" content="Post"><meta property="article:tag" content="terraform"><meta property="article:tag" content="event"><meta property="article:published_time" content="2020-02-05T18:55:37+09:00"><meta property="article:modified_time" content="2020-02-05T18:55:37+09:00"><meta name=twitter:card content="summary"><meta name=twitter:site content="@jkkitakita"><meta name=twitter:creator content="@jkkitakita"><link href=https://blog.jkkitakita.dev/index.xml rel=alternate type=application/rss+xml title=jkkitakita><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://blog.jkkitakita.dev/css/custom.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=https://blog.jkkitakita.dev/post/202002051855/><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"></head><body><section class=section><div class=container><nav id=nav-main class=nav><div id=nav-name class=nav-left><a id=nav-anchor class=nav-item href=https://blog.jkkitakita.dev><h1 id=nav-heading class="title is-4">jkkitakita</h1></a></div><div class=nav-right><nav id=nav-items class="nav-item level is-mobile"><a class=level-item aria-label=github href=https://github.com/jkkitakita target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></i></span></a><a class=level-item aria-label=facebook href=https://facebook.com/jkkitakita target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M18 2h-3a5 5 0 00-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 011-1h3z"/></svg></i></span></a><a class=level-item aria-label=twitter href=https://twitter.com/jkkitakita target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></i></span></a><a class=level-item aria-label=instagram href=https://instagram.com/jkkitakita target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"/><path d="M16 11.37A4 4 0 1112.63 8 4 4 0 0116 11.37z"/><line x1="17.5" y1="6.5" x2="17.5" y2="6.5"/></svg></i></span></a><a class=level-item aria-label=email href=mailto:jkkitakita@gmail.com target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></i></span></a><a class=level-item aria-label=linkedin href=https://linkedin.com/in/jkkitakita target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path stroke-width="1.8" d="m5.839218 4.101561c0 1.211972-.974141 2.194011-2.176459 2.194011S1.4863 5.313533 1.4863 4.101561c0-1.211094.974141-2.194011 2.176459-2.194011s2.176459.982917 2.176459 2.194011zm.017552 3.94922h-4.388022v14.04167H5.85677V8.050781zm7.005038.0H8.501869v14.04167h4.360816v-7.370999c0-4.098413 5.291077-4.433657 5.291077.0v7.370999h4.377491v-8.89101c0-6.915523-7.829986-6.66365-9.669445-3.259423V8.050781z"/></svg></i></span></a></nav></div></nav><nav class=nav></nav></div><script src=/js/navicon-shift.js></script></section><section class=section><div class=container><div class="subtitle tags is-6 is-pulled-right"><a class="subtitle is-6" href=/tags/terraform/>#terraform</a>
| <a class="subtitle is-6" href=/tags/event/>#event</a></div><h2 class="subtitle is-6">February 5, 2020</h2><h1 class=title>Terraform meetup tokyo#4</h1><div class=content><p>今回は、<a href=https://terraform-jp.connpass.com/event/163197/>Terraform meetup tokyo#4</a>に参加してきました。
いつものスタイルと違ったので、ちょっと戸惑いました。。。</p><h2 id=アジェンダ>アジェンダ</h2><ul><li>会社紹介</li><li>スポンサーセッション</li><li>ワールド・カフェに関して</li></ul><h2 id=会社紹介>会社紹介</h2><ul><li>「これからの食卓・これからの〇〇」</li><li>Oisix + らでぃっしゅぼーや + 大地を守る会<ul><li>オイシックス・ラ・大地</li><li>Purple Carrot</li></ul></li><li>ミールキット「Kit Oisix」が人気です。</li><li>エンジニアの会場は誰でも借りれます！</li><li>エンジニアは内製している。</li><li>Kubernetes, Terraform etc&mldr;使ってます。</li></ul><p>誰でも借りれるって行っていたので、機会があれば、是非使いたい！が、ちょっと大崎というのが個人的にはアクセスがあまり。。。笑</p><h2 id=スポンサーセッション>スポンサーセッション</h2><div class=embed><script async class=speakerdeck-embed data-id=7bd0ae3815d84def8bd22e72ab3db4e2 data-slide data-ratio=1.77777777777777 src=//speakerdeck.com/assets/embed.js></script></div><h2 id=ワールドカフェに関して>ワールド・カフェに関して</h2><p>下記スライド参照。<br><a href="https://docs.google.com/presentation/d/1mjuzsWV2Pl8barIM9ZG1xVao6AeTP93U5p7PgR0wQlo/edit#slide=id.p">https://docs.google.com/presentation/d/1mjuzsWV2Pl8barIM9ZG1xVao6AeTP93U5p7PgR0wQlo/edit#slide=id.p</a></p><h2 id=hashicorp-japanさんから>Hashicorp Japanさんから</h2><ul><li>Hashicorp 「Japan」でも、GitHubを持ってます。
<a href=https://github.com/hashicorp-japan>https://github.com/hashicorp-japan</a></li><li>Vaultの紹介<ul><li>アプリが必要な時に、Vault側でDBのcredentialsとかをgenerateできる。</li><li>TTLが設定されるので、テンポラリーなcredentialsにできる。
<a href=https://github.com/hashicorp-japan/vault-workshop>https://github.com/hashicorp-japan/vault-workshop</a></li></ul></li><li>こんなスライドもあるのかと思った。
<a href=https://docs.google.com/presentation/d/14YmrOLYirdWbDg5AwhuIEqJSrYoroQUQ8ETd6qwxe6M/edit>https://docs.google.com/presentation/d/14YmrOLYirdWbDg5AwhuIEqJSrYoroQUQ8ETd6qwxe6M/edit</a></li></ul><hr><h2 id=さて本題>さて、本題</h2><p>以下、「その場で上がっていた課題感」とその「対策」に関して、ざっくりまとめてみました。</p><h3 id=その場で上がっていた課題感>その場で上がっていた課題感</h3><hr><ul><li>ワークスペース利用するかどうか</li><li>どうディレクトリを切ったらいいのか</li><li>本番適用するのはどこから適用するか<ul><li>手動か？CI/CDサービスなどのツールからか？</li></ul></li><li>terraformのOSSにPRを出したいが、リポジトリが大きくて、どこから手を出していいかわからない</li><li>terraformのartifactを他のツール（ansible etc&mldr;）とかのinputにしたい場合はどうすれば良いか</li></ul><h3 id=対策>対策</h3><hr><h4 id=ワークスペース利用するかどうか>ワークスペース利用するかどうか</h4><hr><p>結論としては、「使わなくていいんじゃない？」って人が多かったように思う。理由としては</p><ul><li>分けることのメリットがあまりない。</li><li>hashicorp側でも「環境毎にワークスペースを分けて~」「環境毎に分けないで~」など、公式のbest practiceがバラバラ？</li></ul><p>２つ目の理由に関しては、公式ドキュメントにある通り、複数ワークスペースを利用する場合は、例えば「本番環境をデプロイする前に、同等の環境のコピーを用意する場合に利用する」と記載されているため、そうではない場合は、ワークスペースではなく、そもそも別のものとして分けるのが良いを私は信じたい。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-markdown data-lang=markdown>In particular, organizations commonly want to create a strong separation
between multiple deployments of the same infrastructure serving different
development stages (e.g. staging vs. production) or different internal teams.
In this case, the backend used for each deployment often belongs to that deployment,
with different credentials and access controls.
Named workspaces are not a suitable isolation mechanism for this scenario.
</code></pre></div><p>c.f. <a href=https://www.terraform.io/docs/state/workspaces.html#when-to-use-multiple-workspaces>https://www.terraform.io/docs/state/workspaces.html#when-to-use-multiple-workspaces</a></p><h4 id=どうディレクトリを切ったらいいのか>どうディレクトリを切ったらいいのか</h4><hr><p>これは、結局「サービスレイヤー」と「環境レイヤー」のどっちを上に置くべきかという話がメインの課題だったように感じた。これに関しては、その場でも明確な結論は出ていなかったように思う。理由としては、おそらくシステムアーキテクチャ・組織構造（e.g. マイクロサービスかどうか。どの単位でチームが構成されているか）と密接に絡むため、どっちがいいとかがなかったからかと思う。個人的には、最近の潮流を鑑みるとmercariさんの構成が良きかなと思っている。ただterraform導入フェーズから完璧にこの構成にする必要はないと思っているため、色々なフェーズに合わせて、構成は柔軟に変更したらいいかなと思う。</p><div class=embed><script async class=speakerdeck-embed data-id=a5a56261e3b14115807d0c1320741550 data-slide=21 data-ratio=1.77777777777777 src=//speakerdeck.com/assets/embed.js></script></div><p>ベースとなる構成は、ここのサイトが参考になるかなと思う。
<a href=https://www.terraform-best-practices.com/examples/terraform>https://www.terraform-best-practices.com/examples/terraform</a></p><h4 id=本番適用するのはどこから適用するか>本番適用するのはどこから適用するか</h4><hr><p>この課題は、「証跡・履歴」と「アクセスコントロール」の話。基本的には、CircleCIとかJenkinsとかとかから実行するのがベストかと思われる。これに関しては、特に異論はなかったように思う。</p><h4 id=terraformのossにprを出したいがリポジトリが大きくてどこから手を出していいかわからない>terraformのOSSにPRを出したいが、リポジトリが大きくて、どこから手を出していいかわからない</h4><hr><p>これは、OSSの活動をしたことがないので、困った。笑<br><a href=https://github.com/hashicorp/terraform>https://github.com/hashicorp/terraform</a><br>確かに、大きそうには見えるが、完全に何がしたいか次第かなと思ったりもした。根本のところの修正をしようとすると確かに、キャッチアップが必要かもしれないが、↓のPRのように、puppetのprovisionerを追加するだけなら、まぁなんかいけなくもないかなと感じた。笑（PRにめっちゃ突っ込んでくれて、suggestを出してくれて、直してくれてる雰囲気を感じた笑）</p><p><a href=https://github.com/hashicorp/terraform/pull/18851>https://github.com/hashicorp/terraform/pull/18851</a></p><h4 id=terraformのartifactを他のツールansible-etcとかのinputにしたい場合はどうすれば良いか>terraformのartifactを他のツール（ansible etc&mldr;）とかのinputにしたい場合はどうすれば良いか</h4><p>これは私がちょこちょこ聞いていた質問だが、回答としては、</p><ul><li>AWSなら、EC2のtagを使うことで、間接的に、連携できる。</li><li>AWSのparameter storeを利用する。
<a href=https://docs.aws.amazon.com/ja_jp/kms/latest/developerguide/services-parameter-store.html>https://docs.aws.amazon.com/ja_jp/kms/latest/developerguide/services-parameter-store.html</a></li><li>null resource使って、local fileとして吐き出す。</li></ul><p>1つ目に関しては、よくやる手かなと思った。<br>2つ目に関しては、AWSならではという感じですが、なるほど。<br>3つ目に関しては、あまり使う機会も少ないですが、null resource x provisioner（local-exec）の組み合わせをすればいいという話。resourceが単位でprovisionerを設定するのがオーソドックスかもしれないが、null resourceを使えば、まとめて実行できそうですし、ファイルを吐き出すだけじゃなくても、local-execでscriptを実行すれば、まぁ確かに、なんでもできそう。あまりやらないので、今度そういう機会があれば、やってみようと思った。</p><p>c.f. <a href=https://www.terraform.io/docs/providers/null/resource.html#example-usage>https://www.terraform.io/docs/providers/null/resource.html#example-usage</a></p><h2 id=さいごに>さいごに</h2><p>今回は、「ワールドカフェ」という自分の中では、新しいスタイルでした。就活のグループディスカッションを思い出しました。笑</p><div class=related><h3>Similar articles:</h3><ul><li><a href=/post/202001291937/>Kubernetes Meetup Tokyo #27</a></li><li><a href=/post/202001231917/>DMM.go #1</a></li><li><a href=/post/202001191310/>iOS・SwiftプロジェクトのCI/CDで、bitrise.ymlをリポジトリ内で管理する</a></li><li><a href=/post/202001150046/>Goもくもく会（ごもくかい）#23</a></li></ul></div></div></div></section><script src=/js/copycode.js></script><section class=section><div class="container has-text-centered"><p>(C) <a href=https://github.com/jkkitakita>Jun Kitamura</a> 2020</p></div></section><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-156067080-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script type=text/javascript>var _paq=_paq||[];_paq.push(['trackPageView']);_paq.push(['enableLinkTracking']);(function(){var u="\/\/matomo.example.com\/";_paq.push(['setTrackerUrl',u+'piwik.php']);_paq.push(['setSiteId','1']);var d=document,g=d.createElement('script'),s=d.getElementsByTagName('script')[0];g.type='text/javascript';g.async=true;g.defer=true;g.src=u+'piwik.js';s.parentNode.insertBefore(g,s);})();</script><noscript><img src="//matomo.example.com/piwik.php?idsite=1&rec=1" style=border:0 alt></noscript></body></html>