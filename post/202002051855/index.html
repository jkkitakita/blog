<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://blog.jkkitakita.dev/favicon.ico><link rel=stylesheet href=/css/style.min.css><title>Terraform meetup tokyo#4</title></head><body><header id=banner><h2><a href=https://blog.jkkitakita.dev>jkkitakita</a></h2><nav><ul></ul></nav></header><main id=content><article><header id=post-header><h1>Terraform meetup tokyo#4</h1><div><time>February 5, 2020</time></div></header><p>今回は、<a href=https://terraform-jp.connpass.com/event/163197/>Terraform meetup tokyo#4</a>に参加してきました。
いつものスタイルと違ったので、ちょっと戸惑いました。。。</p><h2 id=アジェンダ>アジェンダ</h2><ul><li>会社紹介</li><li>スポンサーセッション</li><li>ワールド・カフェに関して</li></ul><h2 id=会社紹介>会社紹介</h2><ul><li>「これからの食卓・これからの〇〇」</li><li>Oisix + らでぃっしゅぼーや + 大地を守る会<ul><li>オイシックス・ラ・大地</li><li>Purple Carrot</li></ul></li><li>ミールキット「Kit Oisix」が人気です。</li><li>エンジニアの会場は誰でも借りれます！</li><li>エンジニアは内製している。</li><li>Kubernetes, Terraform etc&mldr;使ってます。</li></ul><p>誰でも借りれるって行っていたので、機会があれば、是非使いたい！が、ちょっと大崎というのが個人的にはアクセスがあまり。。。笑</p><h2 id=スポンサーセッション>スポンサーセッション</h2><div class=embed><script async class=speakerdeck-embed data-id=7bd0ae3815d84def8bd22e72ab3db4e2 data-slide data-ratio=1.77777777777777 src=//speakerdeck.com/assets/embed.js></script></div><h2 id=ワールドカフェに関して>ワールド・カフェに関して</h2><p>下記スライド参照。<br><a href="https://docs.google.com/presentation/d/1mjuzsWV2Pl8barIM9ZG1xVao6AeTP93U5p7PgR0wQlo/edit#slide=id.p">https://docs.google.com/presentation/d/1mjuzsWV2Pl8barIM9ZG1xVao6AeTP93U5p7PgR0wQlo/edit#slide=id.p</a></p><h2 id=hashicorp-japan-さんから>Hashicorp Japan さんから</h2><ul><li>Hashicorp 「Japan」でも、GitHub を持ってます。
<a href=https://github.com/hashicorp-japan>https://github.com/hashicorp-japan</a></li><li>Vault の紹介<ul><li>アプリが必要な時に、Vault 側で DB の credentials とかを generate できる。</li><li>TTL が設定されるので、テンポラリーな credentials にできる。
<a href=https://github.com/hashicorp-japan/vault-workshop>https://github.com/hashicorp-japan/vault-workshop</a></li></ul></li><li>こんなスライドもあるのかと思った。
<a href=https://docs.google.com/presentation/d/14YmrOLYirdWbDg5AwhuIEqJSrYoroQUQ8ETd6qwxe6M/edit>https://docs.google.com/presentation/d/14YmrOLYirdWbDg5AwhuIEqJSrYoroQUQ8ETd6qwxe6M/edit</a></li></ul><hr><h2 id=さて本題>さて、本題</h2><p>以下、「その場で上がっていた課題感」とその「対策」に関して、ざっくりまとめてみました。</p><h3 id=その場で上がっていた課題感>その場で上がっていた課題感</h3><hr><ul><li>ワークスペース利用するかどうか</li><li>どうディレクトリを切ったらいいのか</li><li>本番適用するのはどこから適用するか<ul><li>手動か？CI/CD サービスなどのツールからか？</li></ul></li><li>terraform の OSS に PR を出したいが、リポジトリが大きくて、どこから手を出していいかわからない</li><li>terraform の artifact を他のツール（ansible etc&mldr;）とかの input にしたい場合はどうすれば良いか</li></ul><h3 id=対策>対策</h3><hr><h4 id=ワークスペース利用するかどうか>ワークスペース利用するかどうか</h4><hr><p>結論としては、「使わなくていいんじゃない？」って人が多かったように思う。理由としては</p><ul><li>分けることのメリットがあまりない。</li><li>hashicorp 側でも「環境毎にワークスペースを分けて~」「環境毎に分けないで~」など、公式の best practice がバラバラ？</li></ul><p>２つ目の理由に関しては、公式ドキュメントにある通り、複数ワークスペースを利用する場合は、例えば「本番環境をデプロイする前に、同等の環境のコピーを用意する場合に利用する」と記載されているため、そうではない場合は、ワークスペースではなく、そもそも別のものとして分けるのが良いを私は信じたい。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-markdown data-lang=markdown><span style=display:flex><span>In particular, organizations commonly want to create a strong separation
</span></span><span style=display:flex><span>between multiple deployments of the same infrastructure serving different
</span></span><span style=display:flex><span>development stages (e.g. staging vs. production) or different internal teams.
</span></span><span style=display:flex><span>In this case, the backend used for each deployment often belongs to that deployment,
</span></span><span style=display:flex><span>with different credentials and access controls.
</span></span><span style=display:flex><span>Named workspaces are not a suitable isolation mechanism for this scenario.
</span></span></code></pre></div><p>c.f. <a href=https://www.terraform.io/docs/state/workspaces.html#when-to-use-multiple-workspaces>https://www.terraform.io/docs/state/workspaces.html#when-to-use-multiple-workspaces</a></p><h4 id=どうディレクトリを切ったらいいのか>どうディレクトリを切ったらいいのか</h4><hr><p>これは、結局「サービスレイヤー」と「環境レイヤー」のどっちを上に置くべきかという話がメインの課題だったように感じた。これに関しては、その場でも明確な結論は出ていなかったように思う。理由としては、おそらくシステムアーキテクチャ・組織構造（e.g. マイクロサービスかどうか。どの単位でチームが構成されているか）と密接に絡むため、どっちがいいとかがなかったからかと思う。個人的には、最近の潮流を鑑みると mercari さんの構成が良きかなと思っている。ただ terraform 導入フェーズから完璧にこの構成にする必要はないと思っているため、色々なフェーズに合わせて、構成は柔軟に変更したらいいかなと思う。</p><div class=embed><script async class=speakerdeck-embed data-id=a5a56261e3b14115807d0c1320741550 data-slide=21 data-ratio=1.77777777777777 src=//speakerdeck.com/assets/embed.js></script></div><p>ベースとなる構成は、ここのサイトが参考になるかなと思う。
<a href=https://www.terraform-best-practices.com/examples/terraform>https://www.terraform-best-practices.com/examples/terraform</a></p><h4 id=本番適用するのはどこから適用するか>本番適用するのはどこから適用するか</h4><hr><p>この課題は、「証跡・履歴」と「アクセスコントロール」の話。基本的には、CircleCI とか Jenkins とかとかから実行するのがベストかと思われる。これに関しては、特に異論はなかったように思う。</p><h4 id=terraform-の-oss-に-pr-を出したいがリポジトリが大きくてどこから手を出していいかわからない>terraform の OSS に PR を出したいが、リポジトリが大きくて、どこから手を出していいかわからない</h4><hr><p>これは、OSS の活動をしたことがないので、困った。笑<br><a href=https://github.com/hashicorp/terraform>https://github.com/hashicorp/terraform</a><br>確かに、大きそうには見えるが、完全に何がしたいか次第かなと思ったりもした。根本のところの修正をしようとすると確かに、キャッチアップが必要かもしれないが、↓ の PR のように、puppet の provisioner を追加するだけなら、まぁなんかいけなくもないかなと感じた。笑（PR にめっちゃ突っ込んでくれて、suggest を出してくれて、直してくれてる雰囲気を感じた笑）</p><p><a href=https://github.com/hashicorp/terraform/pull/18851>https://github.com/hashicorp/terraform/pull/18851</a></p><h4 id=terraform-の-artifact-を他のツールansible-etcとかの-input-にしたい場合はどうすれば良いか>terraform の artifact を他のツール（ansible etc&mldr;）とかの input にしたい場合はどうすれば良いか</h4><p>これは私がちょこちょこ聞いていた質問だが、回答としては、</p><ul><li>AWS なら、EC2 の tag を使うことで、間接的に、連携できる。</li><li>AWS の parameter store を利用する。
<a href=https://docs.aws.amazon.com/ja_jp/kms/latest/developerguide/services-parameter-store.html>https://docs.aws.amazon.com/ja_jp/kms/latest/developerguide/services-parameter-store.html</a></li><li>null resource 使って、local file として吐き出す。</li></ul><p>1 つ目に関しては、よくやる手かなと思った。<br>2 つ目に関しては、AWS ならではという感じですが、なるほど。<br>3 つ目に関しては、あまり使う機会も少ないですが、null resource x provisioner（local-exec）の組み合わせをすればいいという話。resource が単位で provisioner を設定するのがオーソドックスかもしれないが、null resource を使えば、まとめて実行できそうですし、ファイルを吐き出すだけじゃなくても、local-exec で script を実行すれば、まぁ確かに、なんでもできそう。あまりやらないので、今度そういう機会があれば、やってみようと思った。</p><p>c.f. <a href=https://www.terraform.io/docs/providers/null/resource.html#example-usage>https://www.terraform.io/docs/providers/null/resource.html#example-usage</a></p><h2 id=さいごに>さいごに</h2><p>今回は、「ワールドカフェ」という自分の中では、新しいスタイルでした。就活のグループディスカッションを思い出しました。笑</p></article></main><footer id=footer></footer></body></html>